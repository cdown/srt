#!/usr/bin/env python

"""Remove subtitles by index or timestamp."""

import srt
import datetime
import srt_tools.utils
import logging

log = logging.getLogger(__name__)

def parse_args():
    examples = {
        "Remove a single caption at index 10": "srt remove -i example.srt --t1 10 --t2 11",
        "Remove captions within :05 - :08": "srt remove -i example.srt --t1 00:00:5,00 --t2 00:00:8,00",
        "Remove captions from index 10 to the end of the file.": "srt remove -i example.srt --t1 10",
        "Remove captions from index 0 to index 10.": "srt remove -i example.srt --t2 10",
        "Remove captions from :16 to the end of the file.": "srt remove -i example.srt --t1 00:00:16,00",
        "Remove captions from index 2 to the 3rd to last index:": "srt remove -i example.srt --t1 2 --t2 -3",
        "Remove captions from index 5 to timestamp :17": "srt remove -i example.srt --t1 5 --t2 00:00:17,00",
        "Remove captions non-sequentially": "srt remove -i example.srt --t1 24 --t2 6",
        "Remove every caption": "srt remove -i example.srt"
    }
    parser = srt_tools.utils.basic_parser(description=__doc__, examples=examples)
    parser.add_argument(
    "--start",
    "--t1",
    metavar=("INDEX or TIMESTAMP"),
    default=0,
    nargs='?',
    help="The index (from 0) or timestamp to start removing from."
    )
    parser.add_argument(
    "--end",
    "--t2",
    metavar=("INDEX or TIMESTAMP"),
    default=0,
    nargs='?',
    help="The index (from 0) or timestamp to stop removing at."
    )
    return parser.parse_args()


def get_timestamp(subs, obj):
    """Parse an object for a datetime.timedelta"""
    if isinstance(obj, datetime.timedelta):
        return obj

    try:
        idx = int(obj)
        list_subs = subs if isinstance(subs, list) else list(subs)
        len_subs = len(list_subs)
        if (idx >= 0 and idx >= len_subs) or (idx < 0 and -idx > len_subs):
            raise IndexError("There is no caption at the specified index.")
        return list_subs[idx].start
    except ValueError:
        try:
            return srt.srt_timestamp_to_timedelta(obj)
        except srt.TimestampParseError:
            raise ValueError("You must enter a whole number index or timestamp (hh:mm:ss,ms) for caption arguments.")


def split(subs, timestamp):
    """
    Splits subtitles at a given timestamp.
    :rtype: :term:`generator` of :py:class:`Subtitle` objects
    """
    # ensures list compatibility
    from types import GeneratorType
    subs = (x for x in subs) if not isinstance(subs, GeneratorType) else subs

    # yield unsplit captions before the timestamp
    idx = 1
    break_subtitle = None
    split_subs = []
    for subtitle in subs:
        if subtitle.start < timestamp and timestamp < subtitle.end:
            yield srt.Subtitle(idx, subtitle.start, timestamp, subtitle.content)
            subtitle.start = timestamp
            split_subs.append(subtitle)
            idx += 1
        elif subtitle.start == timestamp:
            split_subs.append(subtitle)
        elif subtitle.start > timestamp:
            break_subtitle = subtitle
            break
        else:
            yield subtitle
            idx += 1

    # yield split captions (sort to adjust index first)
    split_subs.sort()
    for subtitle in split_subs:
        yield srt.Subtitle(idx, timestamp, subtitle.end, subtitle.content)
        idx += 1

    # yield unsplit captions after the timestamp
    if break_subtitle:
        yield srt.Subtitle(idx, break_subtitle.start, break_subtitle.end, break_subtitle.content)
        idx += 1

    for subtitle in subs:
        yield srt.Subtitle(idx, subtitle.start, subtitle.end, subtitle.content)
        idx += 1


def remove_caption_timestamp(subs, timestamp_one=datetime.timedelta(0), timestamp_two=datetime.timedelta(0)):
    """
    Removes captions from subtitles by timestamp.
    When timestamp one > timestamp two, captions up to index two will be removed
    and captions after index one will be removed.

    :param int timestamp_one: The timestamp to remove from.
    :param int timestamp_two: The timestamp to remove to.
    :rtype: :term:`generator` of :py:class:`Subtitle` objects
    """
    # ensures list compatibility
    from types import GeneratorType
    subs = (x for x in subs) if not isinstance(subs, GeneratorType) else subs

    # edge cases
    sequential = timestamp_one < timestamp_two
    try:
        first_subtitle = next(subs)
    except StopIteration:
        return

    if timestamp_one == timestamp_two:
        return
    elif sequential and timestamp_two <= first_subtitle.start:
        yield first_subtitle
        yield from subs
        return
    elif not sequential and timestamp_one <= first_subtitle.start:
        return

    # Split the caption at the start and end of the block(s).
    subs = split(subs, timestamp_one)
    subs = split(subs, timestamp_two)

    # remove the captions using a generator.
    idx = 1
    if sequential:
        # keep captions before timestamp one
        if first_subtitle.start < timestamp_one:
            yield first_subtitle
            idx += 1
            for subtitle in subs:
                if timestamp_one <= subtitle.start:
                    break
                yield subtitle
                idx += 1

        # remove captions after timestamp one but before timestamp two
        for subtitle in subs:
            if timestamp_two <= subtitle.start:
                yield srt.Subtitle(idx, subtitle.start, subtitle.end, subtitle.content)
                idx += 1
                break

        # keep captions after timestamp two
        for subtitle in subs:
            yield srt.Subtitle(idx, subtitle.start, subtitle.end, subtitle.content)
            idx += 1
    else:
        # remove captions before timestamp two
        if first_subtitle.start < timestamp_two:
            for subtitle in subs:
                if timestamp_two <= subtitle.start :
                    yield subtitle
                    idx += 1
                    break
        else:
            yield first_subtitle
            idx += 1

        # keep captions after timestamp two but before timestamp one
        for subtitle in subs:
            if timestamp_one <= subtitle.start:
                break
            yield srt.Subtitle(idx, subtitle.start, subtitle.end, subtitle.content)
            idx += 1

        # remove captions after timestamp one
        for subtitle in subs:
            pass


def main():
    args = parse_args()
    logging.basicConfig(level=args.log_level)
    srt_tools.utils.set_basic_args(args)

    subs = list(args.input)
    removed_subs = remove_caption_timestamp(subs, get_timestamp(subs, args.start), get_timestamp(subs, args.end))

    output = srt_tools.utils.compose_suggest_on_fail(removed_subs, strict=args.strict)

    try:
        args.output.write(output)
    except (UnicodeEncodeError, TypeError):  # Python 2 fallback
        args.output.write(output.encode(args.encoding))

if __name__ == "__main__":  # pragma: no cover
    main()
